# NetNynja Enterprise - Production Compose Overlay
# Usage:
#   docker compose -f docker-compose.yml -f docker-compose.prod.yml --profile ipam --profile npm --profile stig up -d
#
# REQUIREMENTS:
#   1. Run scripts/validate-prod-env.sh BEFORE starting containers
#   2. All secrets MUST be set via environment variables or .env (no defaults)
#   3. Vault MUST run in production mode (not dev)
#   4. TLS certificates must be provisioned for nginx
#
# This file overrides docker-compose.yml for production hardening:
#   - Removes all dev-default secrets (services fail to start without explicit config)
#   - Switches Vault from dev mode to production mode
#   - Removes source volume mounts (uses built images)
#   - Removes debug ports for infrastructure services
#   - Sets production build targets
#   - Adds read-only filesystem where possible
#   - Restricts environment to production

services:
  # ============================================
  # VAULT — Production mode (not dev)
  # ============================================
  vault:
    environment:
      # Remove dev mode — production Vault requires init + unseal
      VAULT_DEV_ROOT_TOKEN_ID: ""
      VAULT_DEV_LISTEN_ADDRESS: ""
      VAULT_API_ADDR: "https://vault:8200"
      VAULT_CLUSTER_ADDR: "https://vault:8201"
    # Production Vault requires storage backend config
    volumes:
      - vault_data:/vault/data
      - ./infrastructure/vault/config.hcl:/vault/config/config.hcl:ro
    command: ["server"]

  # ============================================
  # APPLICATION SERVICES — Production targets, no dev defaults
  # ============================================

  gateway:
    build:
      target: production
    environment:
      NODE_ENV: production
      # CRITICAL: These MUST be set — no defaults allowed
      VAULT_TOKEN: ${VAULT_TOKEN:?Production Vault token required}
      JWT_SECRET: ${JWT_SECRET:?Production JWT secret required (min 32 chars)}
      CREDENTIAL_ENCRYPTION_KEY: ${CREDENTIAL_ENCRYPTION_KEY:?Production encryption key required}
      # Production rate limits
      RATE_LIMIT_MAX: ${RATE_LIMIT_MAX:-100}
      RATE_LIMIT_AUTH_MAX: ${RATE_LIMIT_AUTH_MAX:-10}
    # Remove source volume mounts — use built image
    volumes: []
    read_only: true
    tmpfs:
      - /tmp

  auth-service:
    build:
      target: production
    environment:
      NODE_ENV: production
      JWT_SECRET: ${JWT_SECRET:?Production JWT secret required (min 32 chars)}
    volumes: []
    read_only: true
    tmpfs:
      - /tmp

  web-ui:
    build:
      target: production
    environment:
      VITE_API_URL: ${VITE_API_URL:?Production API URL required}
    volumes: []

  # ============================================
  # IPAM SERVICES — Production
  # ============================================

  ipam-service:
    build:
      target: production
    environment:
      NODE_ENV: production
      VAULT_TOKEN: ${VAULT_TOKEN:?Production Vault token required}
      JWT_SECRET: ${JWT_SECRET:?Production JWT secret required (min 32 chars)}
      LOG_LEVEL: INFO
    volumes: []
    read_only: true
    tmpfs:
      - /tmp

  ipam-scanner:
    environment:
      VAULT_TOKEN: ${VAULT_TOKEN:?Production Vault token required}
      JWT_SECRET: ${JWT_SECRET:?Production JWT secret required (min 32 chars)}
    volumes: []
    # Scanner needs NET_RAW only — NET_ADMIN removed
    cap_drop:
      - ALL
    cap_add:
      - NET_RAW

  # ============================================
  # NPM SERVICES — Production
  # ============================================

  npm-service:
    build:
      target: production
    environment:
      NODE_ENV: production
      VAULT_TOKEN: ${VAULT_TOKEN:?Production Vault token required}
      JWT_SECRET: ${JWT_SECRET:?Production JWT secret required (min 32 chars)}
      NPM_CREDENTIAL_KEY: ${CREDENTIAL_ENCRYPTION_KEY:?Production encryption key required}
      LOG_LEVEL: INFO
    volumes: []
    read_only: true
    tmpfs:
      - /tmp

  npm-collector:
    environment:
      NPM_CREDENTIAL_KEY: ${CREDENTIAL_ENCRYPTION_KEY:?Production encryption key required}
    volumes: []
    cap_drop:
      - ALL
    cap_add:
      - NET_RAW

  npm-alerts:
    environment:
      NPM_CREDENTIAL_KEY: ${CREDENTIAL_ENCRYPTION_KEY:?Production encryption key required}
    volumes: []

  # ============================================
  # STIG SERVICES — Production
  # ============================================

  stig-service:
    build:
      target: production
    environment:
      NODE_ENV: production
      ENVIRONMENT: production
      VAULT_TOKEN: ${VAULT_TOKEN:?Production Vault token required}
      JWT_SECRET: ${JWT_SECRET:?Production JWT secret required (min 32 chars)}
      STIG_SSH_STRICT_HOST_KEY: "true"
      LOG_LEVEL: INFO
    # Keep stig-library volume, remove source mount
    volumes:
      - stig_reports:/app/output
      - ${STIG_LIBRARY_PATH:?STIG library path required}:/app/stig-library:ro
    read_only: true
    tmpfs:
      - /tmp

  stig-collector:
    environment:
      JWT_SECRET: ${JWT_SECRET:?Production JWT secret required (min 32 chars)}
    volumes: []

  stig-reports:
    environment:
      JWT_SECRET: ${JWT_SECRET:?Production JWT secret required (min 32 chars)}
    volumes:
      - stig_reports:/app/output

  # ============================================
  # SYSLOG SERVICES — Production
  # ============================================

  syslog-service:
    build:
      target: production
    environment:
      NODE_ENV: production
      LOG_LEVEL: INFO
      # SEC-020: Restrict CORS to gateway origin in production
      SYSLOG_CORS_ORIGINS: ${SYSLOG_CORS_ORIGINS:-http://localhost:3001}
    volumes: []
    read_only: true
    tmpfs:
      - /tmp

  syslog-collector:
    environment:
      LOG_LEVEL: INFO
    volumes: []
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE

  syslog-forwarder:
    environment:
      LOG_LEVEL: INFO
    volumes: []

  # ============================================
  # OBSERVABILITY — Production (no debug ports)
  # ============================================

  grafana:
    environment:
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD:?Grafana password required}
      GF_SERVER_ROOT_URL: ${GRAFANA_ROOT_URL:-http://localhost:3002}
    # Remove direct port exposure — access via nginx
    ports: []

  prometheus:
    # Remove direct port exposure — access via nginx
    ports: []

  jaeger:
    # Remove direct port exposure — access via nginx
    ports: []

# ============================================
# ADDITIONAL VOLUMES (Production)
# ============================================

volumes:
  vault_data:
    name: netnynja-vault-data
