# CODEX Combined Review (E2E + Security)

**Generated**: 2026-01-14 08:51:06
**Reviewer**: Codex (read-only)

## 1) Executive Summary

- **E2E status**: BLOCKED (preflight failed under Windows bash + docker CLI access)
- **Security posture**: Medium
- **CI readiness**: At-risk
- **Top 10 actions** to get CI + E2E green (ordered by priority)
  1. Run preflight from an environment where `docker` is accessible to bash (WSL or Git Bash configured) or add a PowerShell equivalent.
  2. Normalize `Testing/infrastructure/preflight.sh` line endings to LF in the repo (avoid CRLF) or provide a Windows wrapper.
  3. Update preflight OpenAPI check to match the gateway Swagger route (`/docs` or `/docs/json`).
  4. Verify and create required E2E users in PostgreSQL once preflight passes.
  5. Confirm JetStream stream checks use the Windows-safe monitor port 8322 (not 8222).
  6. Remove committed `.env` with secrets; rotate dev secrets and keep `.env` local only.
  7. Restrict Postgres/Redis/NATS host port exposure to localhost or internal networks.
  8. Enable NATS auth/TLS for non-dev profiles and ensure the config file is actually loaded.
  9. Make `trustProxy` configurable in auth-service; restrict to trusted proxy IPs in production.

10. Install Poetry and run `poetry run pytest/ruff/mypy` in CI or locally after dependencies are installed.

## 2) Environment & Commands Executed

- Detected versions: node v24.12.0; npm 11.6.2; python 3.13.9; docker 29.1.3; docker compose v5.0.0-desktop.1; poetry not installed; `py` launcher not found.
- Compose profiles used: infra, ipam, npm, stig.
- Commands executed with outcome:
  - `docker compose config` (success; empty services because all services use profiles)
  - `docker compose --profile infra config` (success)
  - `docker compose --profile ipam --profile npm --profile stig config` (success)
  - `docker compose --profile infra --profile ipam --profile npm --profile stig config` (success)
  - `docker compose --profile infra up -d` (failed without Docker access; succeeded with elevated access)
  - `docker compose --profile ipam --profile npm --profile stig up -d` (timed out after 10s but containers started)
  - `docker compose ps` (success)
  - `bash Testing/infrastructure/preflight.sh` (failed due to CRLF line endings)
  - `bash -c "source <(tr -d '\r' < Testing/infrastructure/preflight.sh); main"` (ran, but docker CLI checks failed)

## 3) E2E Results

- Preflight results: failed (docker CLI not available in bash; Postgres/Redis checks failed even though containers were running).
- Full E2E results: not run (blocked by preflight failure and local write constraints).
- Service health snapshot (from `docker compose ps`): all core services up and healthy; collectors/scanner running without health checks.
- Artifacts: none generated.
- Observed preflight warnings: Grafana dashboards missing; OpenAPI spec not available at `/api/docs/openapi.json`; no traces yet; VictoriaMetrics write may have failed.

## 4) Security Findings (Prioritized)

- **ID**: SEC-001
  **Severity**: Medium
  **Category**: Secrets
  **Evidence**: `.env:11`, `.env:21`, `.env:35`, `.env:52`, `.env:106` (plaintext dev credentials and tokens; values redacted)
  **Impact**: Secrets are present in a tracked file; increases risk of accidental leak and insecure defaults in CI/dev.
  **Recommendation**: Remove `.env` from version control, rotate dev credentials, rely on `.env.example` plus secret injection (Vault or CI secrets).
  **Verification**: `git status` shows `.env` untracked; `rg -n "JWT_SECRET|REDIS_PASSWORD|GRAFANA_PASSWORD|VAULT_TOKEN" .env` returns no committed secrets.

- **ID**: SEC-002
  **Severity**: Medium
  **Category**: Messaging
  **Evidence**: `docker-compose.yml:81`, `docker-compose.yml:82` (NATS ports exposed), `infrastructure/nats/nats.conf:46`, `infrastructure/nats/nats.conf:52` (auth/TLS commented)
  **Impact**: NATS client and monitoring endpoints are exposed without auth/TLS; unauthorized publish/subscribe is possible on shared networks.
  **Recommendation**: Enable NATS auth/TLS for non-dev profiles, bind monitoring to localhost, and load the config explicitly (`-c /etc/nats/nats.conf`).
  **Verification**: `curl -s http://localhost:8322/varz` should be blocked or require auth in non-dev; `docker compose config | rg "nats.conf|http_port"` confirms config loading.

- **ID**: SEC-003
  **Severity**: Medium
  **Category**: Database
  **Evidence**: `docker-compose.yml:42` (Postgres port), `docker-compose.yml:59` (Redis port), `.env:11`, `.env:21` (dev passwords; redacted)
  **Impact**: Database and cache are reachable on all interfaces with dev credentials; risky in shared environments or CI runners.
  **Recommendation**: Bind ports to `127.0.0.1` or remove host mappings for internal-only use; enforce strong secrets outside dev.
  **Verification**: `docker compose config | rg "5433|6379"` shows host_ip restrictions; external scans fail to connect.

- **ID**: SEC-004
  **Severity**: Low
  **Category**: Auth
  **Evidence**: `services/auth-service/src/index.ts:28` (`trustProxy: true`)
  **Impact**: IP-based rate limiting and audit logs can be spoofed if the service is exposed directly or behind untrusted proxies.
  **Recommendation**: Make `trustProxy` configurable and default to `false` in production, or set explicit trusted proxy IPs.
  **Verification**: Send a request with forged `X-Forwarded-For` and confirm it is ignored when `trustProxy` is restricted.

## 5) Application Issues (E2E Blockers/Failures)

- **ID**: APP-001
  **Severity**: Blocker
  **Area**: Compose / Preflight
  **Evidence**: `Testing/infrastructure/preflight.sh` fails on Windows due to CRLF line endings; direct run produced `\r` errors and `set: pipefail` errors.
  **Root cause**: Confirmed (CRLF + bash strict mode).
  **Recommendation**: Normalize the script to LF or add a Windows-compatible runner (PowerShell/WSL wrapper).
  **Verification**: `bash Testing/infrastructure/preflight.sh` succeeds without CRLF parsing errors.

- **ID**: APP-002
  **Severity**: Blocker
  **Area**: Preflight / Docker
  **Evidence**: Preflight reported Docker daemon not running and containers not found, while `docker compose ps` showed all containers healthy.
  **Root cause**: Suspected (docker CLI not accessible within the bash environment used for preflight).
  **Recommendation**: Run preflight in WSL or a shell where `docker` resolves to Docker Desktop, or update script to use `docker.exe` on Windows.
  **Verification**: Preflight Docker checks pass and containers are detected.

- **ID**: APP-003
  **Severity**: Medium
  **Area**: Gateway / Docs
  **Evidence**: `apps/gateway/src/plugins/swagger.ts:663` (Swagger UI mounted at `/docs`); preflight checks `/api/docs/openapi.json` and warns.
  **Root cause**: Suspected endpoint mismatch.
  **Recommendation**: Update preflight to check `/docs/json` (or configure swagger to expose `/api/docs/openapi.json`).
  **Verification**: `curl http://localhost:3001/docs/json` returns OpenAPI JSON and preflight reports success.

## 6) Green Path Checklist

### < 30 minutes

- [ ] Run preflight from WSL/Git Bash with Docker access (or add PowerShell wrapper).
- [ ] Fix preflight OpenAPI check to match `/docs/json` or expose `/api/docs/openapi.json`.
- [ ] Confirm NATS monitor checks use port 8322 on Windows.

### Same day

- [ ] Remove `.env` from version control and rotate dev secrets; rely on `.env.example`.
- [ ] Restrict Postgres/Redis/NATS host port exposure or firewall access.
- [ ] Install Poetry and run python lint/tests locally or in CI.

### Backlog

- [ ] Enable NATS auth/TLS for non-dev profiles and ensure config is loaded.
- [ ] Make `trustProxy` configurable across services.

Rerun commands to prove green:

- `docker compose --profile infra --profile ipam --profile npm --profile stig up -d`
- `bash Testing/infrastructure/preflight.sh`
- `cd Testing && python3 -m pytest test_01_authentication.py test_02_gateway.py -v --tb=short`

## 7) Notes / Assumptions / Gaps

- Poetry is not installed locally, so Poetry-based checks were skipped.
- `npm ci`, `npm run lint/typecheck/test/build`, and `npm audit` were not run to avoid creating/modifying repo files beyond the required report.
- Python 3.13.9 is installed locally; project docs recommend 3.11.x, so compatibility should be confirmed for E2E dependencies.
- Preflight warnings (Grafana dashboards, no traces, VictoriaMetrics write) need validation after Docker CLI access is resolved.
