# CODEX Combined Review (E2E + Security)

## 1) Executive Summary

- E2E status: BLOCKED (preflight failed on missing NATS JetStream streams)
- Security posture: Medium
- CI readiness: Failing (E2E blocked; npm scripts fail locally due to TLS/keychain error)
- Top 10 actions to get CI + E2E green fastest (ordered)
  1. Create required NATS JetStream streams (IPAM_DISCOVERY, STIG_AUDIT, SHARED_ALERTS, SHARED_AUDIT) using `npx tsx Testing/setup-nats-streams.ts`.
  2. Re-run `./Testing/run_tests.sh --quick` and confirm preflight passes; then run full `./Testing/run_tests.sh`.
  3. Ensure VAULT_TOKEN is exported so preflight can validate JWT signing keys (aligns with Vault checks).
  4. Seed E2E users in PostgreSQL (see SQL in `Testing/README.md`) before full E2E.
  5. Resolve local Turbo TLS/keychain error so `npm run build|typecheck|lint|test` can execute (or run the same in CI/Linux to verify if it is host-specific).
  6. Remove default dev secrets from `docker-compose.yml` or require explicit env vars for JWT/Vault/NPM credential keys before production use.
  7. Enable NATS auth/TLS for non-dev deployments and restrict host-exposed ports (4222/8222).
  8. Address `npm audit` moderate esbuild advisory by updating Vite/esbuild (evaluate breaking change impact).
  9. Add automatic JetStream stream provisioning at startup to avoid manual setup drift.

10. Document the expected port/env mismatch in E2E docs (.env/README vs compose) to reduce setup errors.

## 2) Environment & Commands Executed

- Detected versions: node v24.11.1, npm 11.6.2, python 3.13.9, docker 29.1.3, docker compose v2.40.3-desktop.1, poetry not installed
- Compose profiles used: infra, ipam, npm, stig
- Commands executed (status):
  - `docker compose config` (success; empty services without profiles)
  - `docker compose --profile infra config` (success)
  - `docker compose --profile ipam --profile npm --profile stig config` (success)
  - `docker compose --profile infra --profile ipam --profile npm --profile stig config` (success)
  - `docker compose --profile infra up -d` (success; required escalated Docker access)
  - `docker compose --profile ipam --profile npm --profile stig up -d` (success; required escalated Docker access)
  - `docker compose ps` (success; required escalated Docker access)
  - `./Testing/run_tests.sh --quick` (failed in sandbox: Docker access denied)
  - `./Testing/run_tests.sh --quick` (failed preflight: missing JetStream streams)
  - `node -v` (success)
  - `npm -v` (success)
  - `python3 --version` (success)
  - `docker --version` (success)
  - `docker compose version` (success)
  - `poetry --version` (failed: command not found)
  - `npm ci` (success)
  - `npm run -s build` (failed: TLS/keychain error)
  - `npm run -s typecheck` (failed: TLS/keychain error)
  - `npm run -s lint` (failed: TLS/keychain error)
  - `npm run -s test` (failed: TLS/keychain error)
  - `npm audit --audit-level=high` (success; 2 moderate vulnerabilities)

## 3) E2E Results

- Preflight results: FAILED (missing NATS JetStream streams); warnings for Vault token check, VictoriaMetrics write, OpenAPI spec, and traces
- Full E2E results: not run (blocked by preflight failure)
- Service health snapshot: all containers running; no unhealthy containers reported by `docker compose ps` (some services lack healthchecks: ipam-scanner, npm-collector, npm-alerts, stig-collector, stig-reports, promtail, web-ui)
- Artifacts: none generated for this run (existing `Testing/reports/*` predate this execution)

## 4) Security Findings (Prioritized)

- ID: SEC-001
  - Severity: High
  - Category: Secrets
  - Evidence (masked):
    - `.env:5` `POSTGRES_USER=netnynja`
    - `.env:6` `POSTGRES_PASSWORD=netnynja-***`
    - `.env:10` `REDIS_PASSWORD=***`
    - `.env:17` `VAULT_DEV_TOKEN=***`
    - `.env:20` `JWT_SECRET=***`
    - `apps/gateway/.env:10` `POSTGRES_URL=postgresql://netnynja:***@localhost:5433/netnynja`
    - `apps/gateway/.env:13` `REDIS_URL=redis://:***@localhost:6379`
    - `apps/gateway/.env:19` `JWT_SECRET=***`
    - `services/auth-service/.env:10` `POSTGRES_URL=postgresql://netnynja:***@localhost:5433/netnynja`
    - `services/auth-service/.env:13` `REDIS_URL=redis://:***@localhost:6379`
    - `services/auth-service/.env:16` `JWT_SECRET=***`
  - Impact: If any of these files are ever committed or shared, credentials for DB/Redis/Vault/JWT are exposed; this is a direct CI/CD and runtime compromise risk.
  - Recommendation: Ensure these files stay out of VCS (`.gitignore` already lists `.env`), rotate any credentials that may have been shared, and move secrets to a proper secret manager for non-dev environments.
  - Verification steps: `git status --ignored` to confirm `.env` files are ignored; rotate creds and re-run auth/DB connectivity checks.

- ID: SEC-002
  - Severity: Medium
  - Category: Secrets
  - Evidence (masked):
    - `docker-compose.yml:97` `VAULT_DEV_ROOT_TOKEN_ID: ${VAULT_DEV_TOKEN:-netnynja-***}`
    - `docker-compose.yml:260` `JWT_SECRET: ${JWT_SECRET:-netnynja-***}`
    - `docker-compose.yml:261` `CREDENTIAL_ENCRYPTION_KEY: ${CREDENTIAL_ENCRYPTION_KEY:-netnynja-***}`
    - `docker-compose.yml:449` `NPM_CREDENTIAL_KEY: ${NPM_CREDENTIAL_KEY:-netnynja-***}`
  - Impact: If operators forget to override defaults, services may run with known dev secrets, increasing risk of credential compromise and token forgery.
  - Recommendation: Remove default secret fallbacks in production compose overlays or enforce required env vars (fail fast when unset); document secure secret injection in CI/CD.
  - Verification steps: `docker compose config` in production profile should show no defaulted secrets; startup should fail if secrets are missing.

- ID: SEC-003
  - Severity: Medium
  - Category: Messaging
  - Evidence:
    - `infrastructure/nats/nats.conf:45` `# No authentication in development (enable in production)`
    - `infrastructure/nats/nats.conf:52` `# TLS configuration (enable in production)`
    - `docker-compose.yml:79` `- "4222:4222"` and `docker-compose.yml:81` `- "8222:8222"`
  - Impact: NATS JetStream is exposed on host ports without auth/TLS, which is unsafe outside isolated dev networks and can allow message injection or data exfiltration.
  - Recommendation: Enable NATS auth and TLS for any shared or production-like environment; restrict host port exposure or bind to localhost.
  - Verification steps: Confirm NATS auth/TLS enabled in `nats.conf`; attempt unauthenticated connect should fail.

- ID: SEC-004
  - Severity: Low
  - Category: Observability
  - Evidence:
    - `apps/gateway/src/index.ts:44` `trustProxy: true`
    - `apps/gateway/src/plugins/metrics.ts:363` `/metrics` uses IP allowlist via `request.ip`
  - Impact: If the gateway is not behind a trusted proxy, client-supplied `X-Forwarded-For` can spoof IPs and bypass allowlist-based protection for `/metrics`.
  - Recommendation: Restrict `trustProxy` to known proxy IPs, or require an auth token/mTLS for `/metrics` in addition to IP allowlist.
  - Verification steps: Confirm `trustProxy` is configured for a trusted proxy chain and validate `/metrics` access with/without spoofed headers.

- ID: SEC-005
  - Severity: Low
  - Category: Dependencies
  - Evidence:
    - `npm audit --audit-level=high` output reports `esbuild <=0.24.2` via Vite with a moderate advisory (GHSA-67mh-4wv8-2f99).
  - Impact: Dev server can be coerced to proxy requests in vulnerable versions; impacts local/dev environments and CI test safety if dev servers are used.
  - Recommendation: Upgrade Vite/esbuild to a patched release (evaluate breaking change warnings).
  - Verification steps: `npm audit --audit-level=high` should return zero vulnerabilities after upgrade.

## 5) Application Issues (E2E Blockers/Failures)

- ID: APP-001
  - Severity: Blocker
  - Area: NATS
  - Evidence:
    - Preflight output:
      "IPAM_DISCOVERY missing", "STIG_AUDIT missing", "SHARED_ALERTS missing", "SHARED_AUDIT missing" (from `./Testing/run_tests.sh --quick`)
  - Root cause: Confirmed (JetStream streams were not present in NATS at preflight time)
  - Recommendation: Run the provided setup script (`npx tsx Testing/setup-nats-streams.ts`) or create streams on service startup.
  - Verification commands: `curl -s http://localhost:8222/jsz?streams=true | rg 'IPAM_DISCOVERY|STIG_AUDIT|SHARED_ALERTS|SHARED_AUDIT'` then `./Testing/run_tests.sh --quick`.

## 6) Green Path Checklist

- < 30 minutes
  - Run `npx tsx Testing/setup-nats-streams.ts`.
  - Export `VAULT_TOKEN` if Vault checks are required by preflight.
  - Seed E2E users in DB (SQL snippet in `Testing/README.md`).
  - Rerun `./Testing/run_tests.sh --quick` and confirm preflight passes.
- Same day
  - Run full suite: `./Testing/run_tests.sh` and capture reports in `Testing/reports/`.
  - Investigate `OpenAPI spec not available` preflight warning and restore `/docs` in gateway if expected.
  - Investigate VictoriaMetrics write warning and confirm `/api/v1/write` health.
- Backlog
  - Enforce secret injection (remove dev defaults in compose, use secret manager in CI/CD).
  - Enable NATS auth/TLS and restrict exposed ports for non-dev environments.
  - Add automatic JetStream stream provisioning during service startup.

## 7) Notes / Assumptions / Gaps

- Poetry is not installed locally, so Python/Poetry checks (pytest/ruff/mypy/bandit) were not run.
- `npm run build/typecheck/lint/test` failed locally due to TLS/keychain error; likely host-specific, but should be verified in CI.
- Preflight warnings observed: VAULT_TOKEN not set (JWT key check skipped), VictoriaMetrics write warning, OpenAPI spec not available, no NetNynja traces yet.
- `docker compose config` without profiles returns an empty services map; ensure profiles are always used for local/E2E runs.
