# CODEX Combined Review (E2E + Security)

**Generated**: 2026-01-12 09:18:52
**Reviewer**: Codex (read-only)

## 1) Executive Summary

- **E2E status**: BLOCKED (Docker not available locally; preflight script missing)
- **Security posture**: High (unauthenticated infra endpoints + dev Vault configuration)
- **CI readiness**: At-risk (npm ci failed on native deps; lint/type/test/build blocked by missing turbo)
- **Top 10 actions** to get CI + E2E green (ordered by priority)
  1. Enable NATS auth + TLS and remove public host bindings for 4222/8222 in production.
  2. Replace dev-mode Vault config with production Vault configuration; remove dev root token usage.
  3. Lock down `TRUST_PROXY` to explicit proxy allowlist in production to prevent spoofing.
  4. Add unzip size/file-count limits to STIG ZIP upload (implemented in this review).
  5. Fix npm ci failures by aligning Node version with supported argon2 prebuilds or enabling build dependencies and network access.
  6. Re-run lint/typecheck/test/build once npm ci succeeds (turbo dependency).
  7. Resolve ruff and mypy violations (1298 ruff, 388 mypy errors).
  8. Add/verify E2E preflight script location or update instructions to match current repo layout.
  9. Ensure observability services (Grafana/Prometheus/Loki/Jaeger) are authenticated or bound to localhost for non-dev.
  10. Add container scanning and SBOM validation gates into CI if/when dependencies stabilize.

## 2) Environment & Commands Executed

- Detected versions: node v22.21.0, npm 11.4.2, python 3.11.12, poetry 2.2.1
- Compose profiles used: none (Docker unavailable)
- Commands executed with success/fail outcome:
  - `docker compose config` → **FAIL** (docker not installed)
  - `npm ci` → **FAIL** (argon2 prebuild download blocked; node headers download 403)
  - `npm run -s lint` → **FAIL** (turbo not installed; npm ci failed)
  - `npm run -s typecheck` → **FAIL** (turbo not installed; npm ci failed)
  - `npm run -s test` → **FAIL** (turbo not installed; npm ci failed)
  - `npm run -s build` → **FAIL** (turbo not installed; npm ci failed)
  - `npm audit --audit-level=high` → **FAIL** (registry 403)
  - `poetry install` → **FAIL** (pypi.org unreachable)
  - `poetry run pytest` → **FAIL** (no tests ran)
  - `poetry run ruff check .` → **FAIL** (1298 lint issues)
  - `poetry run mypy .` → **FAIL** (388 type errors)
  - `bash infrastructure/preflight.sh` → **FAIL** (script missing)

## 3) E2E Results

- Preflight results: **BLOCKED** (no Docker; missing preflight script)
- Full E2E results: **NOT RUN** (preflight blocked)
- Service health snapshot: **N/A** (containers not started)
- Artifacts: **None**

## 4) Security Findings (Prioritized)

**SEC-001**

- **Severity**: High
- **Category**: Messaging
- **Evidence**: NATS runs without auth/TLS (`infrastructure/nats/nats.conf` lines 45-57) and is published to host (`docker-compose.yml` lines 67-82).
- **Impact**: Anyone on the host network can publish/subscribe or access JetStream/monitoring endpoints, potentially exfiltrating data or injecting messages.
- **Recommendation**: Enable NATS auth + TLS in production, and bind ports to localhost or internal-only network. Confirm env vars for NATS credentials are wired into services.
- **Verification**: Attempt unauthenticated connection to 4222/8222 should fail after fix.

**SEC-002**

- **Severity**: High
- **Category**: Secrets / Infrastructure
- **Evidence**: Vault runs in dev mode with static root token and exposed port (`docker-compose.yml` lines 89-100).
- **Impact**: Secrets can be accessed with a predictable token; dev mode is unsuitable for production.
- **Recommendation**: Use production Vault configuration with TLS, remove dev root token, and avoid exposing the service publicly.
- **Verification**: Vault should require TLS and proper auth methods; dev token should be rejected.

**SEC-003**

- **Severity**: Medium
- **Category**: Auth / Rate limiting
- **Evidence**: Gateway defaults `TRUST_PROXY` to `true` (`apps/gateway/src/config.ts` lines 87-100) and rate limiting uses `request.ip` for keys (`apps/gateway/src/plugins/rate-limit.ts` lines 74-85).
- **Impact**: If deployed without a trusted proxy list, attackers can spoof `X-Forwarded-For` to bypass rate limits or IP allowlists.
- **Recommendation**: In production, enforce an explicit allowlist for `TRUST_PROXY` or set it to `false` when not behind a trusted proxy.
- **Verification**: Spoofed `X-Forwarded-For` should not alter rate limit keys when `TRUST_PROXY` is restricted.

**SEC-004**

- **Severity**: Medium
- **Category**: File upload / DoS
- **Evidence**: STIG ZIP upload buffers full ZIP in memory and unzips without caps (`apps/gateway/src/routes/stig/index.ts` lines 488-546).
- **Impact**: ZIP bombs or large file counts can exhaust memory/CPU, causing DoS.
- **Recommendation**: Limit total uncompressed size and file count before processing (implemented in this review).
- **Verification**: Uploading ZIPs exceeding limits should return 400 and not consume excessive memory.

**SEC-005**

- **Severity**: Low
- **Category**: Observability exposure
- **Evidence**: Observability services (VictoriaMetrics, Prometheus, Loki, Jaeger, Grafana) bind host ports in compose (`docker-compose.yml` lines 112-219).
- **Impact**: In non-dev deployments, these endpoints can leak operational data or provide attack surface if exposed without auth.
- **Recommendation**: Bind to localhost in dev or place behind authenticated reverse proxy; enable auth where possible.
- **Verification**: Access to monitoring UIs should be restricted in production.

## 5) Application Issues (E2E Blockers/Failures)

**APP-001**

- **Severity**: Blocker
- **Area**: Compose
- **Evidence**: Docker CLI not available; `docker compose config` failed.
- **Root cause**: Local environment lacks Docker.
- **Recommendation**: Install Docker or run in an environment with Docker access.
- **Verification**: `docker compose config` succeeds.

**APP-002**

- **Severity**: Blocker
- **Area**: Preflight
- **Evidence**: `bash infrastructure/preflight.sh` missing.
- **Root cause**: Script not present at referenced path.
- **Recommendation**: Update CODEXCHECK instructions to point to correct path or add the script.
- **Verification**: Preflight script exists and runs.

**APP-003**

- **Severity**: High
- **Area**: Dependencies
- **Evidence**: `npm ci` failed due to argon2 prebuild download and Node headers 403.
- **Root cause**: Network access blocked to GitHub/Node headers or incompatible Node version.
- **Recommendation**: Ensure network access to binaries or pin Node to supported argon2 ABI versions.
- **Verification**: `npm ci` completes successfully.

**APP-004**

- **Severity**: High
- **Area**: Lint/Typecheck
- **Evidence**: `npm run -s lint/typecheck/test/build` fails because turbo is missing (npm ci failed).
- **Root cause**: Workspace dependencies not installed.
- **Recommendation**: Fix npm ci, then rerun turbo commands.
- **Verification**: `npm run -s lint/typecheck/test/build` succeeds.

**APP-005**

- **Severity**: Medium
- **Area**: Python QA
- **Evidence**: Ruff reports 1298 violations; mypy reports 388 errors.
- **Root cause**: Lint/typecheck violations across Testing and app modules.
- **Recommendation**: Triage and fix lint/type errors or reduce rule scope.
- **Verification**: `poetry run ruff check .` and `poetry run mypy .` return zero errors.

## 6) Green Path Checklist

### < 30 minutes

- [ ] Install/enable Docker in the environment and rerun compose config.
- [ ] Fix npm ci by aligning Node version and enabling required network access.
- [ ] Rerun `npm run -s lint/typecheck/test/build` after successful install.

### Same day

- [ ] Harden NATS auth/TLS and restrict published ports in production.
- [ ] Replace dev Vault configuration and remove dev token usage.
- [ ] Lock down `TRUST_PROXY` to explicit proxy allowlist in production.

### Backlog

- [ ] Address ruff/mypy issues across apps/Testing.
- [ ] Add auth controls for monitoring endpoints or place behind reverse proxy.

Include rerun commands:

- `docker compose config`
- `npm ci`
- `npm run -s lint`
- `npm run -s typecheck`
- `npm run -s test`
- `npm run -s build`

## 7) Notes / Assumptions / Gaps

- Docker not available in this environment.
- Poetry install blocked by network connectivity to PyPI.
- npm audit blocked by registry 403 (proxy).
- Preflight script referenced in CODEXCHECK is missing from `infrastructure/`.

## 8) Recommended Patch Plan

### P0 (Immediate)

- None implemented in this review (requires environment-level changes).

### P1 (Security fixes implemented)

**Patch**: Add ZIP safety limits to STIG upload to mitigate zip-bomb/DoS risk.

- **Changed files**: `apps/gateway/src/routes/stig/index.ts`
- **Diff snippet**:

  ```diff

  ```

*      const maxZipFiles = 500;
*      const maxUncompressedBytes = 100 * 1024 * 1024; // 100 MB
  @@

-        const directory = await unzipper.Open.buffer(fileBuffer);

*        const directory = await unzipper.Open.buffer(fileBuffer);
*        const fileCount = directory.files.length;
*        if (fileCount > maxZipFiles) {
*          reply.status(400);
*          return {
*            success: false,
*            error: {
*              code: "ZIP_TOO_MANY_FILES",
*              message: `ZIP contains too many files (${fileCount}). Max allowed is ${maxZipFiles}.`,
*            },
*          };
*        }
*
*        const totalUncompressedBytes = directory.files.reduce((sum, file) => {
*          const uncompressed =
*            typeof file.uncompressedSize === "number" ? file.uncompressedSize : 0;
*          return sum + uncompressed;
*        }, 0);
*        if (totalUncompressedBytes > maxUncompressedBytes) {
*          reply.status(400);
*          return {
*            success: false,
*            error: {
*              code: "ZIP_TOO_LARGE",
*              message: `ZIP uncompressed size exceeds limit (${maxUncompressedBytes} bytes).`,
*            },
*          };
*        }

  ```

  ```

- **How to test**:
  - `npm run -s test -w apps/gateway`
  - Manually upload a ZIP with >500 files or >100MB uncompressed size and verify a 400 response.

### P2 (Backlog)

- Enforce NATS auth + TLS and restrict ports in production (config change + service updates).
- Replace Vault dev mode with production configuration; remove dev root token.
- Enforce `TRUST_PROXY` allowlist in production.

## 9) What I’d verify with the team

- Is NATS expected to be externally reachable in any environment, or should it be strictly internal?
- Should monitoring endpoints be accessible off-host, or only via VPN/internal networks?
- Where is the intended preflight script location (or is it deprecated)?
- What is the supported Node.js version range for native dependencies like argon2?
- Are there expected size limits for STIG packages that should guide ZIP caps?
