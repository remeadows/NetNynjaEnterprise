# CODEX Combined Review (E2E + Security)

**Generated**: 2026-01-31 06:42:24
**Reviewer**: Codex (read-only)

## 1) Executive Summary

- **E2E status**: FAIL (1 failing test in auth refresh invalid-token path)
- **Security posture**: Medium (dev defaults + proxy trust defaults need explicit production hardening; security checks not fully run)
- **CI readiness**: At-risk (E2E failure; npm/poetry checks not executed)
- **Top 10 actions** to get CI + E2E green (ordered by priority)
  1) Fix auth refresh endpoint to return 401 for invalid refresh tokens.
  2) Rerun quick E2E (`test_01_authentication.py`, `test_02_gateway.py`) to validate fix.
  3) Run full E2E suite and capture HTML report.
  4) Resolve npm log directory permissions and run `npm ci`.
  5) Run `npm run -s lint`, `npm run -s typecheck`, `npm run -s test`, `npm run -s build`.
  6) Run `npm audit --audit-level=high`.
  7) Install Poetry locally (if required) and run Python checks.
  8) Review CORS/proxy trust defaults for production hardening.
  9) Ensure Vault token is set for JWT signing key checks in preflight.
  10) Re-run preflight to confirm no regressions.

## 2) Environment & Commands Executed

- Detected versions: node v24.11.1, npm 11.6.2, python 3.13.9, docker 29.1.3, docker compose v5.0.1, poetry not installed
- Compose profiles used: `infra`, `ipam`, `npm`, `stig`
- Commands executed with success/fail outcome:
  - `docker compose --profile infra up -d` ✅ (with elevated permissions)
  - `docker compose --profile ipam --profile npm --profile stig up -d` ✅ (with elevated permissions)
  - `docker compose ps` ✅
  - `bash tests/infrastructure/preflight.sh` ✅ (with elevated permissions; warnings only)
  - `pip3 install pytest pytest-asyncio pytest-html pytest-cov httpx redis psycopg psycopg-binary nats-py` ✅ (already satisfied)
  - `python3 -m pytest test_01_authentication.py test_02_gateway.py -v --tb=short` ❌ (1 failure)

## 3) E2E Results

- Preflight results: PASS (warnings: Vault JWT key check skipped due to missing VAULT_TOKEN; VictoriaMetrics write warning; no traces yet)
- Quick E2E results: **1 failed, 40 passed, 3 skipped** in 3.62s
- Failed test: `test_01_authentication.py::TestTokenRefresh::test_refresh_with_invalid_token_returns_401` (expected 401, got 200)
- Skipped tests: OpenAPI/Swagger UI not implemented (3 skips)
- Artifacts: `tests/e2e/reports/api-test-report.html`

## 4) Security Findings (Prioritized)

### SEC-001
- **Severity**: Medium
- **Category**: Secrets / Auth
- **Evidence**: `docker-compose.yml` defaults for Vault token, JWT secret, and encryption key (dev fallbacks)
- **Impact**: Predictable secrets if defaults are used in production or CI.
- **Recommendation**: Require explicit env values in CI/prod and remove/guard dev fallbacks.
- **Verification**: `docker compose config` shows no default secrets in CI/prod.

### SEC-002
- **Severity**: Low
- **Category**: Auth / Proxy
- **Evidence**: `apps/gateway/src/config.ts:93-101` TRUST_PROXY defaults to `true` with warning in production.
- **Impact**: Potential client IP spoofing if `TRUST_PROXY=true` is used in production.
- **Recommendation**: Enforce explicit trusted proxy list or `false` in production.
- **Verification**: Gateway fails or warns loudly in production if TRUST_PROXY is not explicit.

## 5) Application Issues (E2E Blockers/Failures)

### APP-001
- **Severity**: High
- **Area**: Auth
- **Evidence**: `test_01_authentication.py::TestTokenRefresh::test_refresh_with_invalid_token_returns_401` returns 200 OK instead of 401.
- **Root cause**: Suspected refresh endpoint accepts invalid tokens.
- **Recommendation**: Validate refresh token signature/expiry and return 401 on invalid token.
- **Verification**: Rerun quick E2E tests; ensure this test passes.

## 6) Green Path Checklist

### < 30 minutes

- [ ] Fix refresh-token invalid path to return 401.
- [ ] Rerun quick E2E tests (auth + gateway).

### Same day

- [ ] Run full E2E suite and capture reports.
- [ ] Resolve npm log directory permissions; run npm CI + lint/typecheck/tests/build.

### Backlog

- [ ] Install Poetry (if required) and run Python lint/typecheck/tests.
- [ ] Harden production defaults for secrets and proxy trust.

## 7) Notes / Assumptions / Gaps

- npm/Poetry checks not executed (npm log dir error; Poetry not installed).
- Preflight warnings include missing VAULT_TOKEN for JWT key checks and VictoriaMetrics write warning.
