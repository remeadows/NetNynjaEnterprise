# CODEX App Review (E2E)

## 1) Summary

- E2E status: BLOCKED
- Total: Passed 21 (preflight), Failed 2 (preflight), Warnings 4; API/Frontend tests not run
- Primary blockers to getting E2E green (top 5):
  - Gateway not running/reachable on `http://localhost:3001`.
  - `auth-service` container unhealthy, blocking gateway startup.
  - `npm-collector` and `npm-alerts` containers crash on startup (structlog logger name error).
  - `stig-collector` and `stig-reports` containers crash on import (`TypeError: 'staticmethod' object is not subscriptable`).
  - Grafana health check failing in preflight (port mismatch with compose defaults).

## 2) Environment & Setup

- OS/runtime versions:
  - Node: v24.11.1
  - npm: 11.6.2
  - Python: 3.13.9 (pip 25.3)
  - Poetry: not installed
  - Docker: 29.1.3
  - Docker Compose: v2.40.3-desktop.1
- Services started:
  - `docker compose --profile infra up -d`
  - `docker compose --profile ipam --profile npm --profile stig up -d` (timed out at 10s but containers started)
- Key env vars required (names only):
  - `POSTGRES_PASSWORD`, `REDIS_PASSWORD`, `JWT_SECRET`, `GATEWAY_URL`, `GRAFANA_PORT`, `POSTGRES_URL`, `REDIS_URL`, `NATS_URL`, `VAULT_ADDR`

## 3) Commands Executed

- `rg --files -g 'README.md' -g 'PROJECT_STATUS.md' -g 'DOCKER_STRUCTURE.md' -g 'docker-compose.yml' -g 'docker-compose.*.yml'` → located documentation + compose files.
- `rg --files -g 'package.json' -g 'pyproject.toml' -g 'poetry.lock' -g 'pytest.ini' -g 'playwright.config.*' -g 'cypress.config.*'` → located package/test configs.
- `rg --files Testing scripts .github/workflows` → discovered E2E harness and CI workflows.
- `command -v docker` → `/usr/local/bin/docker`.
- `sed -n '1,200p' Testing/README.md` → E2E harness overview.
- `sed -n '1,200p' Testing/run_tests.sh` → E2E runner logic.
- `sed -n '1,200p' docker-compose.yml` → stack definition.
- `sed -n '1,200p' README.md` / `DOCKER_STRUCTURE.md` / `PROJECT_STATUS.md` / `.env.example` → env and expectations.
- `node --version` → `v24.11.1`.
- `npm --version` → `11.6.2`.
- `python3 --version` → `Python 3.13.9`.
- `pip --version` → `pip 25.3`.
- `poetry --version` → not found.
- `docker --version` → `Docker version 29.1.3`.
- `docker compose version` → `v2.40.3-desktop.1`.
- `docker compose config` → returned empty services (no profiles selected).
- `docker compose --profile infra config` → rendered infra services.
- `docker compose --profile infra up -d` → started infra containers.
- `docker compose ps` → multiple services running, several restarting.
- `docker compose logs --tail=200 ipam-scanner` → repeated runtime warning on module execution.
- `docker compose logs --tail=200 npm-collector` → crash with `AttributeError: 'PrintLogger' object has no attribute 'name'`.
- `docker compose logs --tail=200 npm-alerts` → same crash as above.
- `docker compose logs --tail=200 stig-collector` → crash with `TypeError: 'staticmethod' object is not subscriptable`.
- `docker compose logs --tail=200 stig-reports` → same crash as above.
- `docker compose up -d` → `no service selected` (all services are profile-gated).
- `docker compose --profile ipam --profile npm --profile stig up -d` → timed out at 10s; services started.
- `docker compose ps` → `auth-service` unhealthy; workers restarting.
- `docker compose ps gateway web-ui` → no gateway/web-ui containers.
- `docker compose --profile ipam --profile npm --profile stig up -d gateway web-ui` → failed: `auth-service` unhealthy.
- `docker compose logs --tail=200 auth-service` → no fatal error; service logs show activity.
- `curl -sS -o /tmp/auth-health.txt -w "%{http_code}" http://localhost:3006/healthz` → failed to connect.
- `./Testing/run_tests.sh --quick` → preflight failed (Grafana health + Gateway not responding); no API/Frontend tests executed.
- `nl -ba Testing/infrastructure/preflight.sh | sed -n '610,720p'` → located Grafana/Gateway checks and trace warning line.
- `nl -ba apps/stig/src/stig/db/repository.py | sed -n '520,590p'` → located `get_recent` annotation at line 556-557.
- `nl -ba apps/npm/src/npm/collectors/snmp_poller.py | sed -n '240,320p'` → located `configure_logging()` + startup logging line.
- `nl -ba apps/npm/src/npm/services/alert_service.py | sed -n '200,270p'` → located `configure_logging()` + startup logging line.
- `nl -ba apps/npm/src/npm/core/logging.py | sed -n '1,120p'` → located `PrintLoggerFactory` usage.
- `ls -lt Testing/reports | head -20` → no new reports generated in this run.

## 4) Failures & Issues (Prioritized)

### APP-001

- Severity: Blocker
- Area: API
- Evidence:
  - failing test: preflight `API GATEWAY CONNECTIVITY`
  - file: `Testing/infrastructure/preflight.sh:704`
  - excerpt:
    ```
    if curl -sf "${GATEWAY_URL}/healthz" ...; then
      ...
    else
      log_fail "Gateway not responding"
    ```
  - run output (preflight):
    ```
    8. API GATEWAY CONNECTIVITY
      ├─ Gateway health endpoint... ✗ FAIL - Gateway not responding
    ```
- Likely root cause: Confirmed. Gateway container is not running (`docker compose ps gateway web-ui` shows none), and `GATEWAY_URL` defaults to `http://localhost:3001`.
- Recommendation:
  1. Start `gateway` and `web-ui` services with profiles: `docker compose --profile ipam --profile npm --profile stig up -d gateway web-ui`.
  2. Ensure `auth-service` health is green (see APP-002), since gateway depends on it.
- Verification steps:
  - `curl -sSf http://localhost:3001/healthz`
  - `docker compose ps gateway web-ui`
  - Re-run `./Testing/run_tests.sh --quick`

### APP-002

- Severity: Blocker
- Area: Auth
- Evidence:
  - command output: `docker compose ps` shows `netnynja-auth-service` **unhealthy**.
  - `curl -sS http://localhost:3006/healthz` → connection failure.
- Likely root cause: Suspected. Health endpoint not reachable on host despite container running; could be repeated restarts or port binding/healthcheck mismatch.
- Recommendation:
  1. Inspect healthcheck failures: `docker inspect --format '{{json .State.Health}}' netnynja-auth-service`.
  2. Validate port exposure and service readiness: `curl -sSf http://localhost:3006/healthz`.
  3. If `auth-service` is not reachable, rebuild or restart with correct env (`POSTGRES_PASSWORD`, `REDIS_PASSWORD`, `JWT_SECRET`).
- Verification steps:
  - `docker compose ps auth-service`
  - `curl -sSf http://localhost:3006/healthz`

### APP-003

- Severity: High
- Area: Tooling
- Evidence:
  - failing test: preflight `OBSERVABILITY STACK`
  - file: `Testing/infrastructure/preflight.sh:627`
  - excerpt:
    ```
    local grafana_health=$(curl -sf "http://localhost:${GRAFANA_PORT}/api/health" ...)
    if echo "$grafana_health" | grep -q '"database":.*"ok"'; then
      ...
    else
      log_fail "Grafana not healthy"
    ```
  - run output:
    ```
    7. OBSERVABILITY STACK
      ├─ Grafana health... ✗ FAIL - Grafana not healthy
    ```
- Likely root cause: Confirmed. `GRAFANA_PORT` defaults to `3000` in preflight, while compose maps Grafana to host port `3002` (see `docker-compose.yml` and `.env.example`).
- Recommendation:
  1. Export `GRAFANA_PORT=3002` before running `Testing/infrastructure/preflight.sh`.
  2. Alternatively, update preflight to source `.env` or use `GRAFANA_PORT` default `3002`.
- Verification steps:
  - `GRAFANA_PORT=3002 ./Testing/infrastructure/preflight.sh`

### APP-004

- Severity: High
- Area: NPM
- Evidence:
  - failing service: `npm-collector` / `npm-alerts` (restarting)
  - logs excerpt:
    ```
    AttributeError: 'PrintLogger' object has no attribute 'name'
    File "/usr/local/lib/python3.11/site-packages/npm/collectors/snmp_poller.py", line 269, in main
      logger.info("starting_snmp_poller_service")
    ```
  - repo code references:
    - `apps/npm/src/npm/collectors/snmp_poller.py:268-269`
    - `apps/npm/src/npm/services/alert_service.py:223-224`
    - `apps/npm/src/npm/core/logging.py:34-35` (uses `structlog.PrintLoggerFactory()`)
- Likely root cause: Confirmed. `PrintLoggerFactory` produces loggers without `.name`, which breaks `structlog.stdlib.add_logger_name` in the container runtime.
- Recommendation:
  1. Switch to `structlog.stdlib.LoggerFactory()` or remove `add_logger_name` processor for PrintLogger.
  2. Rebuild NPM services and confirm containers stay healthy.
- Verification steps:
  - `docker compose up -d npm-collector npm-alerts`
  - `docker compose logs --tail=50 npm-collector npm-alerts`

### APP-005

- Severity: High
- Area: STIG
- Evidence:
  - failing service: `stig-collector` / `stig-reports` (restarting)
  - logs excerpt:
    ```
    File "/usr/local/lib/python3.11/site-packages/stig/db/repository.py", line 555
      async def get_recent(limit: int = 10) -> list[AuditJob]:
                                               ~~~~^^^^^^^^^^
    TypeError: 'staticmethod' object is not subscriptable
    ```
  - repo code reference: `apps/stig/src/stig/db/repository.py:556-557`
- Likely root cause: Suspected. Import-time type annotation is failing due to a name collision (e.g., `list` or `AuditJob`) or runtime typing configuration in the container image.
- Recommendation:
  1. Check for name collisions (`list`, `AuditJob`) in `apps/stig/src/stig/db/repository.py` imports.
  2. If running with `from __future__ import annotations`, ensure runtime uses `typing.List` or string annotations.
- Verification steps:
  - Rebuild `stig-collector` and `stig-reports` images after fix.
  - `docker compose logs --tail=50 stig-collector stig-reports`

### APP-006

- Severity: Medium
- Area: IPAM
- Evidence:
  - failing service: `ipam-scanner` (restarting)
  - logs excerpt:
    ```
    RuntimeWarning: 'ipam.collectors.nats_handler' found in sys.modules after import
    ... prior to execution of 'ipam.collectors.nats_handler'
    ```
- Likely root cause: Suspected. Module executed twice or re-imported; may be exiting early and restarting.
- Recommendation:
  1. Inspect scanner entrypoint to avoid double-import/run of `ipam.collectors.nats_handler`.
  2. Add explicit logging on exit to confirm the stop reason.
- Verification steps:
  - `docker compose logs --tail=50 ipam-scanner`
  - `docker compose ps ipam-scanner`

### APP-007

- Severity: Low
- Area: Tooling
- Evidence:
  - file: `Testing/infrastructure/preflight.sh:675-679`
  - excerpt:
    ```
    local services=$(curl -sf "http://localhost:16686/api/services" ... | grep -c "netnynja" || echo "0")
    if [ "$services" -gt 0 ]; then
    ```
  - run output:
    ```
    line 679: [: 0
    0: integer expression expected
    ```
- Likely root cause: Confirmed. `services` contains a newline (`"0\n0"`) and breaks integer comparison.
- Recommendation:
  1. Sanitize `services` to a single integer (`tr -d '\n'`), similar to dashboard count logic.
- Verification steps:
  - `./Testing/infrastructure/preflight.sh` (check warning removed)

## 5) “Green Path” Checklist

**< 1 hour**

- Set `GRAFANA_PORT=3002` and re-run preflight (`Testing/infrastructure/preflight.sh`).
- Make `auth-service` healthy and reachable; restart if needed.
- Start `gateway` + `web-ui` containers with profiles.

**Same day**

- Fix structlog logger factory in NPM services and rebuild containers.
- Fix STIG repository annotation/type issue and rebuild collectors/reports.
- Investigate `ipam-scanner` restart loop; keep worker alive.

**Backlog**

- Update preflight script to source `.env` (ports/credentials) for consistent local runs.
- Add CI E2E job that validates gateway + worker container health before tests.

## 6) Artifacts

- No new HTML/JUnit reports generated (preflight failed before pytest).
- Existing reports (previous runs): `Testing/reports/*`.
